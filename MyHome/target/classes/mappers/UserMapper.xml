<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.spring.myWeb.user.mapper.IUserMapper">
     <resultMap type="com.spring.myWeb.command.UserVO" id="user">
        <id column="id" property="id" />
        <result column="pw" property="pw" />
        <result column="nick_name" property="nickName" />
        <result column="phone1" property="phone1" />
        <result column="phone2" property="phone2" />
        <result column="phone3" property="phone3" />
        <result column="grade" property="grade" />
        <result column="interest" property="interest" />
        <result column="addr_basic" property="addrBasic" />
        <result column="addr_detail" property="addrDetail" />
        <result column="zip_num" property="zipNum" />
        <result column="major" property="major" />
        <result column="profile" property="profile" />
        <result column="scrap" property="scrap" />
     </resultMap>
     
     <resultMap type="com.spring.myWeb.command.MyHomeVO" id="MyHomeList">
     	<id property="bno" column="bno"/>
     	<result property="writer" column="writer"/>
     	<result property="title" column="title"/>
     	<result property="regDate" column="regdate"/>
     	<result property="viewCnt" column="view_cnt"/>
     </resultMap>
 
 	<resultMap type="com.spring.myWeb.command.QuizVO" id="QuizList">
 		<id property="quizNum" column="quiz_num"/>
 		<result property="title" column="title"/>
 		<result property="type" column="type"/>
 		<result property="writer" column="writer"/>
 		<result property="regDate" column="reg_date"/>
 		<result property="views" column="views"/> 
 	</resultMap>
 	
 	<sql id="type">
 		<if test="type == 'home'">FROM myhome</if>
 		<if test="type == 'quiz'">FROM quiz</if>
 	</sql>
 	
 	<!--  
 	<sql id="articles">
 		<if test="articleType"></if>
 	</sql>
 	-->
 	 	
    <insert id="userJoin">
        insert into users(id, pw, nick_name, phone1, phone2, phone3, grade, interest, addr_basic, addr_detail, zip_num, major, profile, scrap)
        values (#{id}, #{pw}, #{nickName}, #{phone1}, #{phone2}, #{phone3}, #{grade, jdbcType=VARCHAR}, #{interest, jdbcType=VARCHAR}, #{addrBasic}, #{addrDetail, jdbcType=VARCHAR}, #{zipNum}, #{major, jdbcType=VARCHAR}, #{profile, jdbcType=VARCHAR}, #{scrap, jdbcType=VARCHAR})
    </insert>
    
    <update id="userUpdate">
    	UPDATE users
    	SET phone1=#{phone1}, phone2=#{phone2}, phone3=#{phone3}, interest=#{interest}, addr_basic=#{addrBasic}, addr_detail=#{addrDetail}, zip_num=#{zipNum}, profile=#{profile}
		WHERE id=#{id}    	
    </update>
 
 	<select id="pwCheck" resultType="int">
 		SELECT COUNT(*) 
 		FROM users
 		WHERE id=#{id}
 		AND pw=#{pw}
 	</select>
 	
 	<delete id="userDelete">
 		DELETE FROM users
 		WHERE id = #{id} 
 	</delete>
 	
 	<select id="userLogin" resultMap="user">
		SELECT * FROM users
		WHERE id = #{id}
		AND pw = #{pw}
	</select>
	
	<select id="idCheck" resultType="int">
		SELECT COUNT (*) FROM users
		WHERE id = #{id}
	</select>
	
	<select id="nickCheck" resultType="int">
		SELECT COUNT (*) FROM users
		WHERE nick_name = #{nickName}
	</select>
	
	<select id="userInfo" resultMap="user">
		SELECT * FROM users
		WHERE id = #{id}
		
	</select>
	
	<select id="homeArticles" resultMap="MyHomeList">
		SELECT *
		FROM
		(
			SELECT ROWNUM rn, tbl.*
			FROM
			(
				SELECT 
				h.bno, h.writer, h.title, h.regdate, h.view_cnt
				FROM users u LEFT JOIN myhome h
				ON u.nick_name = h.writer		
				WHERE u.nick_name = #{nick}
				ORDER BY h.bno DESC
			) tbl
		)
		<![CDATA[
		WHERE rn > (#{page.pageNum}-1)*#{page.countPerPage}
		AND rn < #{page.pageNum}*#{page.countPerPage}
		]]>
	</select>
	
	<select id="quizArticles" resultMap="QuizList">
		SELECT *
		FROM
		(
			SELECT ROWNUM rn, tbl.*
			FROM
			(
				SELECT 
				q.quiz_num, q.writer, q.title, q.reg_date, q.views
				FROM users u LEFT JOIN quiz q
				ON u.nick_name = q.writer		
				WHERE u.nick_name = #{nick}
				ORDER BY q.quiz_num DESC
			) tbl
		)
		<![CDATA[
		WHERE rn > (#{page.pageNum}-1)*#{page.countPerPage}
		AND rn < #{page.pageNum}*#{page.countPerPage}
		]]>
	</select>
	
	<select id="getTotalCount" resultType="int">
		SELECT COUNT(*)
		<include refid="type" />
		WHERE writer = #{nick}
	</select>
	
 
</mapper>
